name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, staging]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.ts
            **/*.tsx
            **/*.js
            **/*.jsx
            **/*.json
            **/*.prisma

      - name: Setup Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Claude Code
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff for review
          git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > /tmp/diff.txt

          # Create review prompt
          cat << 'EOF' > /tmp/review-prompt.txt
          You are reviewing a pull request for the Zimbabwe e-Arrival Card system.
          This is a government application handling sensitive traveler data.

          Please review the following code changes and provide feedback on:
          1. Security concerns (input validation, authentication, authorization)
          2. Code quality and best practices
          3. Potential bugs or edge cases
          4. Performance considerations
          5. Accessibility compliance

          Be concise but thorough. Format your response as GitHub-flavored markdown.
          Start with a summary, then list specific concerns with file:line references.
          EOF

          # Run Claude Code for review (if API key is available)
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "Running Claude review..."
            claude -p "$(cat /tmp/review-prompt.txt)" --print < /tmp/diff.txt > /tmp/review.md 2>/dev/null || echo "Claude review skipped"

            if [ -f /tmp/review.md ] && [ -s /tmp/review.md ]; then
              echo "## Claude Code Review" > /tmp/comment.md
              echo "" >> /tmp/comment.md
              cat /tmp/review.md >> /tmp/comment.md
              echo "" >> /tmp/comment.md
              echo "---" >> /tmp/comment.md
              echo "*Automated review by Claude Code*" >> /tmp/comment.md
            fi
          else
            echo "ANTHROPIC_API_KEY not set, skipping Claude review"
          fi

      - name: Post review comment
        if: steps.changed-files.outputs.any_changed == 'true' && hashFiles('/tmp/comment.md') != ''
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('/tmp/comment.md', 'utf8');

            if (comment.trim()) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  commit-review:
    name: Commit Review
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit-info
        run: |
          echo "message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "files=$(git diff --name-only HEAD~1 HEAD | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Log commit for review
        run: |
          echo "Commit by: ${{ steps.commit-info.outputs.author }}"
          echo "Message: ${{ steps.commit-info.outputs.message }}"
          echo "Files changed: ${{ steps.commit-info.outputs.files }}"
